@model GestaoObras.Domain.Entities.Obra
@{
  ViewData["Title"] = $"Obra: {Model?.Nome}";
  var currentUrl = ViewContext.HttpContext?.Request?.Path + ViewContext.HttpContext?.Request?.QueryString;

  // returnUrl base (fallback para dados gerais)
  string baseReturnUrl = Url.Action("Details", "Obras", new { id = Model?.Id }) ?? "/";

  // returnUrl por aba (para voltar ao sítio certo depois de submit)
  string returnUrlMov = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "mov" }) ?? baseReturnUrl;
  string returnUrlMao = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "mao" }) ?? baseReturnUrl;
  string returnUrlPag = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "pag" }) ?? baseReturnUrl;

  string activeTab = (ViewBag.ActiveTab as string) ?? ""; // "mov" | "mao" | "pag" | ""
  string FormatCoord(double? v) => v.HasValue ? v.Value.ToString("0.00000") : "-";

  // Helper local para badge de operação (Entrada/Saída)
  string Badge(string op) => op == "Entrada" ? "badge bg-success"
  : op == "Saida" ? "badge bg-danger"
  : "badge bg-secondary";
}

<div class="card-header d-flex align-items-center gap-2">
  <h3 class="card-title mb-0">@Model?.Nome</h3>

  <div class="ms-auto d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm" asp-action="Edit" asp-route-id="@Model?.Id"
      asp-route-returnUrl="@(currentUrl ?? baseReturnUrl)">
      <i class="fa-solid fa-pen-to-square"></i> Editar
    </a>
    <a class="btn btn-outline-secondary btn-sm" asp-action="Index">
      <i class="fa-solid fa-arrow-left"></i> Voltar
    </a>
  </div>
</div>

<div class="card-body">
  <ul class="nav nav-tabs" id="obraTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link @(string.IsNullOrEmpty(activeTab) ? "active" : "")" id="dados-tab" data-bs-toggle="tab"
        data-bs-target="#dados" type="button" role="tab">Dados Gerais</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "mov" ? "active" : "")" id="movimentos-tab" data-bs-toggle="tab"
        data-bs-target="#movimentos" type="button" role="tab">Registo de Material</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "mao" ? "active" : "")" id="mao-tab" data-bs-toggle="tab"
        data-bs-target="#mao" type="button" role="tab">Registo de Mão-de-Obra</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "pag" ? "active" : "")" id="pagamentos-tab" data-bs-toggle="tab"
        data-bs-target="#pagamentos" type="button" role="tab">Registo de Pagamentos</button>
    </li>
  </ul>

  <div class="tab-content p-3 border border-top-0 rounded-bottom">

    @* --- TAB: Dados Gerais --- *@
    <div class="tab-pane fade @(string.IsNullOrEmpty(activeTab) ? "show active" : "")" id="dados" role="tabpanel"
      aria-labelledby="dados-tab">
      <dl class="row mb-0">
        <dt class="col-sm-3">Cliente</dt>
        <dd class="col-sm-9">@Model?.Cliente?.Nome (@Model?.Cliente?.Email)</dd>

        <dt class="col-sm-3">Morada</dt>
        <dd class="col-sm-9">@Model?.Morada</dd>

        <dt class="col-sm-3">Latitude</dt>
        <dd class="col-sm-9">@FormatCoord(Model?.Latitude)</dd>

        <dt class="col-sm-3">Longitude</dt>
        <dd class="col-sm-9">@FormatCoord(Model?.Longitude)</dd>

        <dt class="col-sm-3">Ativa</dt>
        <dd class="col-sm-9">@(Model?.Ativa == true ? "Sim" : "Não")</dd>
      </dl>
    </div>

    @* --- TAB: Registo de Material --- *@
    <div class="tab-pane fade @(activeTab == "mov" ? "show active" : "")" id="movimentos" role="tabpanel"
      aria-labelledby="movimentos-tab">
      <h5 class="mb-3">Movimentos de Material</h5>

      @if (!(Model?.MovimentosMaterial?.Any() ?? false))
      {
        <div class="alert alert-info">Ainda não existem movimentos para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Material</th>
                <th>Operação</th>
                <th class="text-end">Quantidade</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var m in Model!.MovimentosMaterial!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@m.DataHora.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@m.Material?.Nome</td>
                  <td><span class="@Badge(m.Operacao.ToString())">@m.Operacao</span></td>
                  <td class="text-end">@m.Quantidade</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo movimento</h6>
      <form asp-controller="MovimentosMaterial" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlMov" />

        <div class="col-md-5">
          <label class="form-label">Material</label>
          <select class="form-select" name="MaterialId" asp-items="ViewBag.MaterialId"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Operação</label>
          <select class="form-select" name="Operacao"
            asp-items="Html.GetEnumSelectList<GestaoObras.Domain.Enums.OperacaoStock>()"></select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Quantidade</label>
          <input class="form-control" type="number" name="Quantidade" min="1" value="1" />
        </div>

        <div class="col-md-2 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Lançar</button>
        </div>
      </form>
    </div>

    @* --- TAB: Mão-de-Obra --- *@
    <div class="tab-pane fade @(activeTab == "mao" ? "show active" : "")" id="mao" role="tabpanel"
      aria-labelledby="mao-tab">
      <h5 class="mb-3">Mão-de-Obra</h5>

      @if (TempData["FormError_mao"] is string errMao)
      {
        <div class="alert alert-danger">@errMao</div>
      }

      @if (!(Model?.MaosDeObra?.Any() ?? false))
      {
        <div class="alert alert-info">Sem registos de mão-de-obra para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th class="text-end">Horas</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var h in Model!.MaosDeObra!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@h.DataHora.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@h.Nome</td>
                  <td class="text-end">@h.HorasTrabalhadas</td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger js-open-delete"
                      data-action="@Url.Action("Delete", "MaosDeObra")" data-id="@h.Id" data-return="@returnUrlMao"
                      data-label="registo de mão-de-obra">
                      Apagar
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo registo</h6>
      <form asp-controller="MaosDeObra" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlMao" />

        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="Nome" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Horas</label>
          <input class="form-control" type="number" step="0.25" name="HorasTrabalhadas" value="1" />
        </div>

        <div class="col-md-3 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Registar</button>
        </div>
      </form>
    </div>

    @* --- TAB: Pagamentos --- *@
    <div class="tab-pane fade @(activeTab == "pag" ? "show active" : "")" id="pagamentos" role="tabpanel"
      aria-labelledby="pagamentos-tab">
      <h5 class="mb-3">Pagamentos</h5>

      @if (TempData["FormError_pag"] is string errPag)
      {
        <div class="alert alert-danger">@errPag</div>
      }

      @if (!(Model?.Pagamentos?.Any() ?? false))
      {
        <div class="alert alert-info">Ainda não existem pagamentos registados para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th class="text-end">Valor</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var p in Model!.Pagamentos!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@p.DataHora.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@p.Nome</td>
                  <td class="text-end">
                    @p.Valor.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("pt-PT"))
                  </td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger js-open-delete"
                      data-action="@Url.Action("Delete", "Pagamentos")" data-id="@p.Id" data-return="@returnUrlPag"
                      data-label="pagamento">
                      Apagar
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo pagamento</h6>
      <form asp-controller="Pagamentos" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlPag" />

        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="Nome" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Valor</label>
          <input class="form-control" type="number" step="0.01" name="Valor" value="0" />
        </div>

        <div class="col-md-3 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Registar</button>
        </div>
      </form>
    </div>

  </div>
</div>

@* Modal genérico de confirmação de remoção *@
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmar remoção</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Tem a certeza que pretende apagar este <strong id="delete-entity-label">registo</strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="deleteForm" method="post">
          @Html.AntiForgeryToken()
          <input type="hidden" name="id" id="delete-id" />
          <input type="hidden" name="returnUrl" id="delete-return" />
          <button type="submit" class="btn btn-danger">Apagar</button>
        </form>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    (function () {
      const modalEl = document.getElementById('confirmDeleteModal');
      if (!modalEl) return;
      const modal = new bootstrap.Modal(modalEl);
      const form = document.getElementById('deleteForm');
      const idInp = document.getElementById('delete-id');
      const retInp = document.getElementById('delete-return');
      const label = document.getElementById('delete-entity-label');

      document.addEventListener('click', function (ev) {
        const btn = ev.target.closest('.js-open-delete');
        if (!btn) return;

        form.action = btn.getAttribute('data-action') || '';
        idInp.value = btn.getAttribute('data-id') || '';
        retInp.value = btn.getAttribute('data-return') || '';
        label.textContent = btn.getAttribute('data-label') || 'registo';
        modal.show();
      }, false);
    })();
  </script>
}