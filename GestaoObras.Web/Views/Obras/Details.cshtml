@model GestaoObras.Domain.Entities.Obra
@{
  ViewData["Title"] = $"Obra: {Model?.Nome}";
  // returnUrl base (fallback para dados gerais)
  string baseReturnUrl = Url.Action("Details", "Obras", new { id = Model?.Id }) ?? "/";
  // returnUrl por aba (para voltar ao sítio certo depois de submit)
  string returnUrlMov = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "mov" }) ?? baseReturnUrl;
  string returnUrlMao = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "mao" }) ?? baseReturnUrl;
  string returnUrlPag = Url.Action("Details", "Obras", new { id = Model?.Id, tab = "pag" }) ?? baseReturnUrl;

  string activeTab = (ViewBag.ActiveTab as string) ?? ""; // "mov" | "mao" | "pag" | ""
  string FormatCoord(double? v) => v.HasValue ? v.Value.ToString("0.00000") : "-";
}

<div class="card-header d-flex align-items-center gap-2">
  <h3 class="card-title mb-0">@Model?.Nome</h3>
  <div class="ms-auto">
    <a class="btn btn-outline-secondary btn-sm" asp-action="Index">
      <i class="fa-solid fa-arrow-left"></i> Voltar
    </a>
  </div>
</div>

<div class="card-body">
  <ul class="nav nav-tabs" id="obraTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link @(string.IsNullOrEmpty(activeTab) ? "active" : "")" id="dados-tab" data-bs-toggle="tab"
        data-bs-target="#dados" type="button" role="tab">Dados Gerais</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "mov" ? "active" : "")" id="movimentos-tab" data-bs-toggle="tab"
        data-bs-target="#movimentos" type="button" role="tab">Registo de Material</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "mao" ? "active" : "")" id="mao-tab" data-bs-toggle="tab"
        data-bs-target="#mao" type="button" role="tab">Registo de Mão-de-Obra</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "pag" ? "active" : "")" id="pagamentos-tab" data-bs-toggle="tab"
        data-bs-target="#pagamentos" type="button" role="tab">Registo de Pagamentos</button>
    </li>
  </ul>

  <div class="tab-content p-3 border border-top-0 rounded-bottom">
    <!-- TAB: Dados Gerais -->
    <div class="tab-pane fade @(string.IsNullOrEmpty(activeTab) ? "show active" : "")" id="dados" role="tabpanel"
      aria-labelledby="dados-tab">
      <dl class="row mb-0">
        <dt class="col-sm-3">Cliente</dt>
        <dd class="col-sm-9">@Model?.Cliente?.Nome (@Model?.Cliente?.Email)</dd>

        <dt class="col-sm-3">Morada</dt>
        <dd class="col-sm-9">@Model?.Morada</dd>

        <dt class="col-sm-3">Latitude</dt>
        <dd class="col-sm-9">@FormatCoord(Model?.Latitude)</dd>

        <dt class="col-sm-3">Longitude</dt>
        <dd class="col-sm-9">@FormatCoord(Model?.Longitude)</dd>

        <dt class="col-sm-3">Ativa</dt>
        <dd class="col-sm-9">@(Model?.Ativa == true ? "Sim" : "Não")</dd>
      </dl>
    </div>

    <!-- TAB: Registo de Material -->
    <div class="tab-pane fade @(activeTab == "mov" ? "show active" : "")" id="movimentos" role="tabpanel"
      aria-labelledby="movimentos-tab">
      <h5 class="mb-3">Movimentos de Material</h5>

      @if (!(Model?.MovimentosMaterial?.Any() ?? false))
      {
        <div class="alert alert-info">Ainda não existem movimentos para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Material</th>
                <th>Operação</th>
                <th class="text-end">Quantidade</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var m in Model!.MovimentosMaterial!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@m.DataHora.ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@m.Material?.Nome</td>
                  <td>@m.Operacao</td>
                  <td class="text-end">@m.Quantidade</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo movimento</h6>
      <form asp-controller="MovimentosMaterial" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlMov" />

        <div class="col-md-5">
          <label class="form-label">Material</label>
          <select class="form-select" name="MaterialId" asp-items="ViewBag.MaterialId"></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Operação</label>
          <!-- Se OperacaoStock = {Entrada=1, Saida=2}, usa "Entrada"/"Saida" (names) ou 1/2 (ints).
                 Aqui uso os nomes para melhor legibilidade. -->
          <select class="form-select" name="Operacao"
            asp-items="Html.GetEnumSelectList<GestaoObras.Domain.Enums.OperacaoStock>()"></select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Quantidade</label>
          <input class="form-control" type="number" name="Quantidade" min="1" value="1" />
        </div>

        <div class="col-md-2 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Lançar</button>
        </div>
      </form>
    </div>

    <!-- TAB: Registo de Mão-de-Obra -->
    <div class="tab-pane fade @(activeTab == "mao" ? "show active" : "")" id="mao" role="tabpanel"
      aria-labelledby="mao-tab">
      <h5 class="mb-3">Mão-de-Obra</h5>

      @if (TempData["FormError_mao"] is string errMao)
      {
        <div class="alert alert-danger">@errMao</div>
      }

      @if (!(Model?.MaosDeObra?.Any() ?? false))
      {
        <div class="alert alert-info">Sem registos de mão-de-obra para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th class="text-end">Horas</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var h in Model!.MaosDeObra!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@h.DataHora.ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@h.Nome</td>
                  <td class="text-end">@h.HorasTrabalhadas</td>
                  <td class="text-end">
                    <form asp-controller="MaosDeObra" asp-action="Delete" method="post" class="d-inline">
                      @Html.AntiForgeryToken()
                      <input type="hidden" name="id" value="@h.Id" />
                      <input type="hidden" name="returnUrl" value="@returnUrlMao" />
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Apagar este registo de mão-de-obra?');">
                        Apagar
                      </button>
                    </form>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo registo</h6>
      <form asp-controller="MaosDeObra" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlMao" />

        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="Nome" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Horas</label>
          <input class="form-control" type="number" step="0.25" name="HorasTrabalhadas" value="1" />
        </div>

        <div class="col-md-3 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Registar</button>
        </div>
      </form>
    </div>

    <!-- TAB: Registo de Pagamentos -->
    <div class="tab-pane fade @(activeTab == "pag" ? "show active" : "")" id="pagamentos" role="tabpanel"
      aria-labelledby="pagamentos-tab">
      <h5 class="mb-3">Pagamentos</h5>

      @if (TempData["FormError_pag"] is string errPag)
      {
        <div class="alert alert-danger">@errPag</div>
      }

      @if (!(Model?.Pagamentos?.Any() ?? false))
      {
        <div class="alert alert-info">Ainda não existem pagamentos registados para esta obra.</div>
      }
      else
      {
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Nome</th>
                <th class="text-end">Valor</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var p in Model!.Pagamentos!.OrderByDescending(x => x.DataHora))
              {
                <tr>
                  <td>@p.DataHora.ToString("yyyy-MM-dd HH:mm")</td>
                  <td>@p.Nome</td>
                  <td class="text-end">@p.Valor.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("pt-PT"))</td>
                  <td class="text-end">
                    <form asp-controller="Pagamentos" asp-action="Delete" method="post" class="d-inline">
                      @Html.AntiForgeryToken()
                      <input type="hidden" name="id" value="@p.Id" />
                      <input type="hidden" name="returnUrl" value="@returnUrlPag" />
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Apagar este pagamento?');">
                        Apagar
                      </button>
                    </form>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <h6 class="mt-4">Novo pagamento</h6>
      <form asp-controller="Pagamentos" asp-action="Create" method="post" class="row g-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ObraId" value="@Model?.Id" />
        <input type="hidden" name="returnUrl" value="@returnUrlPag" />

        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="Nome" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Valor</label>
          <input class="form-control" type="number" step="0.01" name="Valor" value="0" />
        </div>

        <div class="col-md-3 d-grid">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" type="submit">Registar</button>
        </div>
      </form>
    </div>
  </div>
</div>